<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>优教产品系列-优教班班通</title>
  <script src="/jump/crypto-js.js"></script>
  <!-- <script src="/jump/vconsole.min.js"></script> -->
</head>
<body>
  <h2 class="center">内容加载中.....</h2>
  <script>
      // 初始化
    // var vConsole = new VConsole();
    // console.log('Hello world');
    getTokenInfo();
    
    function getTokenInfo () {
      console.log('获取url 参数----', getUrlArgs());
      const authParam = {
        username: 'youke',
        authTimestamp: new Date().getTime()
        },
        key = initAes('4e8759c58fdb413dcc2c243eebab91f6', 9);
      const aa = encrypt(JSON.stringify(authParam), key);
      const bb = new FormData();
      bb.append('authParam', aa);
      // console.log('aaa----', bb);
      fetch('/gw/ucsapi/sso/oauth/service/token?grant_type=vistor', {
        method: 'POST',
        body: bb,
        headers: {
          // 'Content-Type': 'multipart/form-data',
          Authorization: 'Basic dmlzdG9yOjg5YTkxMDg0ZjhhY2EwYTBmMzczZWIzMzFmZGVjZTQ0'
        }
      }).then(response => response.json())
        .then(json => {
          console.log('---调用成功----', json);
          if (json) {
            const obj = getUrlArgs();
            if (obj && obj.speciaSubjectId) {
              if (isMobile()) {
                // const auth_token = localStorage.getItem('auth_token');
                // if (!auth_token) {
                localStorage.setItem('auth_token', encodeURIComponent(JSON.stringify(json)));
                document.cookie = `ut=${json.access_token}`;
                // }
                const para = { id: obj.speciaSubjectId, catalogId: ''};
                window.location.href = `${window.location.origin}/nrmsui/resourceapl/mobile/subjectProDetail/` + JSON.stringify(para);
              } else {
                localStorage.setItem('auth_token', encodeURIComponent(JSON.stringify(json)));
                document.cookie = `ut=${json.access_token}`;
                window.location.href = `${window.location.origin}/nrmsui/resourceapl/pc/specialSubjectView?speciaSubjectId=${obj.speciaSubjectId}`;
              }
            } else {
              alert('暂未配置');
            }
          }
        })
        .catch(err => {
          console.log('---调用失败----');
          console.log(err);
        })
    }

    function initAes (keyStr, n) {
       if (keyStr.length < n) {
        throw new Error('n过大');
       }
      return keyStr.substr(n).concat(keyStr.substr(0, n));
    }

    // 加密
    function encrypt (word, aesKey) {
      const key = CryptoJS.enc.Utf8.parse(aesKey),
      srcs = CryptoJS.enc.Utf8.parse(word),
      encrypted = CryptoJS.AES.encrypt(srcs, key, {
        mode: CryptoJS.mode.ECB,
        padding: CryptoJS.pad.Pkcs7
      });
      return encrypted.toString();
    }

    // 获取url 参数
    function getUrlArgs() {
      const argStr = window.location.search ? window.location.search.substring(1) : '',
        argObj = {},
        argArr = argStr.length > 0 ? argStr.split('&') : [];
        let item = null,
        value = null,
        key = null;
        for (var i = 0, len = argArr.length; i < len; i++) {
          item = argArr[i].split('=');
          key = decodeURIComponent(item[0]);
          value = decodeURIComponent(item[1]);
          argObj[key] = value;
        }
        return argObj;
    };

    function isMobile () {
        return !!navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);
    };
  </script>
</body>
</html>

